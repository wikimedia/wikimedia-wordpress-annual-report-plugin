document.addEventListener("DOMContentLoaded",(()=>{const e=window.mapboxgl;e.accessToken=wmf.apiKey;const t=document.getElementById("map"),s=document.getElementsByClassName("wp-block-wmf-reports-marker"),i=document.getElementById("map-back"),l=document.getElementById("map-forward"),a=new e.NavigationControl,o=new e.Map({attributionControl:!1,container:"map",center:[8.18,11.83],projection:"equalEarth",scrollZoom:!1,style:t?.dataset?.mapStyle||"mapbox://styles/mapbox/light-v11",zoom:1});let r=0,n=!1,c=!0;o.addControl(a);const d=e=>{r=e;const t=s[e],i=document.getElementsByClassName("marker"),l=Array.from(i).filter((e=>e.dataset.id===t.id)),a=document.querySelector('.wp-block-wmf-reports-marker[style*="visibility: visible"]');let o=0;a&&(o=Array.from(s).findIndex((e=>parseInt(a.id)===parseInt(e.id)))),Array.from(i).forEach((e=>{e.classList.remove("active")})),l.forEach((e=>{e.classList.add("active");const t=e.closest(".wp-block-group[id]")?.id;c?c=!1:location.hash=`${t}-${e.dataset.id}`})),Array.from(s).forEach(((s,i)=>{if(!n&&i!==e){if(i===o&&o!==e)return e>=o?(t.style.height=null,t.style.opacity=0,s.style.opacity=1,s.style.position="absolute",s.style.zIndex=1,s.classList.add("animate"),setTimeout((()=>{s.style.height=t.offsetHeight,s.style.opacity=0,n=!0}),1),setTimeout((()=>{s.style.height=0,s.style.opacity=null,s.style.position=null,s.style.visibility="hidden",s.style.zIndex=null,s.classList.remove("animate"),n=!1}),250),t.style.height=null,t.style.opacity=null,void(t.style.visibility="visible")):e<o?(t.style.height=null,t.style.opacity=0,t.style.position="absolute",t.style.visibility="visible",s.style.height=null,s.style.opacity=1,s.style.visibility="visible",setTimeout((()=>{t.classList.add("animate"),s.classList.add("animate")}),1),setTimeout((()=>{t.style.opacity=1,s.style.height=t.offsetHeight+"px",n=!0}),2),setTimeout((()=>{s.style.opacity=0}),250),void setTimeout((()=>{t.style.height=null,t.style.opacity=null,t.style.position=null,t.style.visibility="visible",t.classList.remove("animate"),s.style.height=0,s.style.opacity=null,s.style.visibility="hidden",s.classList.remove("animate"),n=!1}),250)):void 0;s.style.height=0,s.style.visibility="hidden"}}))};d(0);const m=s[0]&&s[0].closest(".carousel--uninitialized");m&&m.classList.remove("carousel--uninitialized"),i.addEventListener("click",(()=>{const e=Array.from(s).findIndex((e=>"visible"===e.style.visibility)),t=e-1<0?s.length-1:e-1;d(t)})),l.addEventListener("click",(()=>{let e=Array.from(s).findIndex((e=>"visible"===e.style.visibility));e<0&&(e=0);const t=e+1>s.length-1?0:e+1;d(t)})),o.on("load",(()=>{o.addSource("markers",{type:"geojson",data:{type:"FeatureCollection",features:Array.from(s).map(((e,t)=>({geometry:{type:"Point",coordinates:[e?.dataset?.long||0,e?.dataset?.lat||0]},type:"Feature",properties:{id:e?.id,index:t}})))||[]},cluster:!0,clusterRadius:10,clusterProperties:{sum:["get","count",["get","value",["properties"]]]}}),o.addLayer({id:"marker_circle",type:"circle",source:"markers",filter:["!=","cluster",!0],paint:{"circle-color":"#000","circle-radius":1}}),o.addLayer({id:"marker_label",type:"symbol",source:"markers",filter:["!=","cluster",!0],layout:{"text-field":"{point_count_abbreviated}","text-size":10},paint:{"circle-color":"#000","text-color":"white"}}),o.on("render",(()=>{o.isSourceLoaded("markers")&&(()=>{const t=o.querySourceFeatures("markers"),s=document.getElementsByClassName("marker"),i=document.getElementsByClassName("cluster"),l=[],a=[];for(const n of t){const t=n.geometry.coordinates,{cluster:c,cluster_id:m,id:y,index:u}=n.properties,p=Array.from(s).filter((e=>e?.dataset?.id===y))?.[0]||null,h=Array.from(i).filter((e=>parseInt(e?.dataset?.clusterId)===m))?.[0]||null;if(c){if(!h){const s=document.createElement("div");s.className="cluster",s.dataset.clusterId=m,s.innerHTML=n.properties.point_count_abbreviated,new e.Marker(s).setDraggable(!1).setLngLat(t).addTo(o)}a.includes(m)||a.push(m)}if(!c){if(!p){const s=document.createElement("div");s.className="marker",s.dataset.id=y,new e.Marker(s).setDraggable(!1).setLngLat(t).addTo(o),u===r&&s.classList.add("active"),s.addEventListener("click",(()=>{d(u);const e=document.getElementById("map").getBoundingClientRect().top+window.scrollY+-140;window.scrollTo({top:e,behavior:"smooth"})}))}l.includes(y)||l.push(y)}}Array.from(s).forEach((e=>{l.includes(e?.dataset?.id)||e.remove()})),Array.from(i).forEach((e=>{a.includes(parseInt(e?.dataset?.clusterId))||e.remove()}))})()}))}));const y=location.hash.slice(location.hash.lastIndexOf("-")+1),u=document.getElementById(y);if(u){const e=u.closest(".map.carousel");e&&setTimeout((()=>{e.scrollIntoView({block:"start",behavior:"smooth"});const t=[...u.parentElement.children].findIndex((({id:e})=>e===y));d(t)}),200)}}));
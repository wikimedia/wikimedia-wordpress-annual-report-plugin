(()=>{"use strict";document.addEventListener("DOMContentLoaded",(()=>{const e=window.mapboxgl;if(!wmf?.apiKey||!e)return void console.error("Unable to initialize mapbox. API key or mapbox global unavailable.");e.accessToken=wmf.apiKey;const t=document.getElementById("map"),i=document.getElementsByClassName("wp-block-wmf-reports-marker"),s=document.getElementById("map-back"),o=document.getElementById("map-forward"),a=new e.NavigationControl,l=new e.Map({attributionControl:!1,container:"map",center:[parseFloat(t?.dataset?.longitude||0),parseFloat(t?.dataset?.latitude||0)],projection:"equirectangular",renderWorldCopies:!1,scrollZoom:!1,style:t?.dataset?.mapStyle||"mapbox://styles/mapbox/light-v11",zoom:parseFloat(t?.dataset?.zoom||1)});let r=0,n=!1;l.addControl(a);const c=(e,t=!0)=>{r=e;const s=i[e],o=document.getElementsByClassName("marker"),a=Array.from(o).filter((e=>e.dataset.id===s.id)),l=document.querySelector('.wp-block-wmf-reports-marker[style*="visibility: visible"]');let c=0;l&&(c=Array.from(i).findIndex((e=>parseInt(l.id)===parseInt(e.id)))),Array.from(o).forEach((e=>{e.classList.remove("active")})),a.forEach((e=>{e.classList.add("active");const i=e.closest(".wp-block-group[id]")?.id||"map";t&&e.dataset.id&&(location.hash=`${i}-${e.dataset.id}`,(e=>{const t=e.closest(".map.carousel");t&&function(e,t){if(t&&function(e){const{top:t,bottom:i}=e.getBoundingClientRect(),{innerHeight:s}=window;return t>=0&&i<=s}(e))return;const i=window.getComputedStyle(document.body).getPropertyValue("--scroll-margin-top")||0;window.scrollTo({behavior:"smooth",top:e.getBoundingClientRect().top-document.body.getBoundingClientRect().top-(parseInt(i,10)+8)})}(t)})(e))})),Array.from(i).forEach(((t,i)=>{if(!n&&i!==e){if(i===c&&c!==e)return e>=c?(s.style.height=null,s.style.opacity=0,t.style.opacity=1,t.style.position="absolute",t.style.zIndex=1,t.classList.add("animate"),setTimeout((()=>{t.style.height=s.offsetHeight,t.style.opacity=0,n=!0}),1),setTimeout((()=>{t.style.height=0,t.style.opacity=null,t.style.position=null,t.style.visibility="hidden",t.style.zIndex=null,t.classList.remove("animate"),n=!1}),250),s.style.height=null,s.style.opacity=null,void(s.style.visibility="visible")):e<c?(s.style.height=null,s.style.opacity=0,s.style.position="absolute",s.style.visibility="visible",t.style.height=null,t.style.opacity=1,t.style.visibility="visible",setTimeout((()=>{s.classList.add("animate"),t.classList.add("animate")}),1),setTimeout((()=>{s.style.opacity=1,t.style.height=s.offsetHeight+"px",n=!0}),2),setTimeout((()=>{t.style.opacity=0}),250),void setTimeout((()=>{s.style.height=null,s.style.opacity=null,s.style.position=null,s.style.visibility="visible",s.classList.remove("animate"),t.style.height=0,t.style.opacity=null,t.style.visibility="hidden",t.classList.remove("animate"),n=!1}),250)):void 0;t.style.height=0,t.style.visibility="hidden"}}))},d=i[0]&&i[0].closest(".carousel--uninitialized");d&&d.classList.remove("carousel--uninitialized"),s&&s.addEventListener("click",(()=>{const e=Array.from(i).findIndex((e=>"visible"===e.style.visibility)),t=e-1<0?i.length-1:e-1;c(t,!1)})),o&&o.addEventListener("click",(()=>{let e=Array.from(i).findIndex((e=>"visible"===e.style.visibility));e<0&&(e=0);const t=e+1>i.length-1?0:e+1;c(t,!1)})),l.on("load",(()=>{l.addSource("markers",{type:"geojson",data:{type:"FeatureCollection",features:Array.from(i).map(((e,t)=>({geometry:{type:"Point",coordinates:[e?.dataset?.long||0,e?.dataset?.lat||0]},type:"Feature",properties:{id:e?.id,index:t}})))||[]},cluster:!0,clusterRadius:10,clusterProperties:{sum:["get","count",["get","value",["properties"]]]}}),l.addLayer({id:"marker_circle",type:"circle",source:"markers",filter:["!=","cluster",!0],paint:{"circle-color":"#000","circle-radius":1}}),l.addLayer({id:"marker_label",type:"symbol",source:"markers",filter:["!=","cluster",!0],layout:{"text-field":"{point_count_abbreviated}","text-size":10},paint:{"icon-color":"#000","text-color":"white"}}),l.on("render",(()=>{l.isSourceLoaded("markers")&&(()=>{const t=l.querySourceFeatures("markers"),i=document.getElementsByClassName("marker"),s=document.getElementsByClassName("cluster"),o=[],a=[];for(const n of t){const d=n.geometry.coordinates,{cluster:m,cluster_id:u,id:y,index:p}=n.properties,g=Array.from(i).filter((e=>e?.dataset?.id===y))?.[0]||null,f=Array.from(s).filter((e=>parseInt(e?.dataset?.clusterId)===u))?.[0]||null;if(m){if(!f){const i=document.createElement("div");i.className="cluster",i.dataset.clusterId=u,i.innerHTML=n.properties.point_count_abbreviated,new e.Marker(i).setDraggable(!1).setLngLat(d).addTo(l),i.addEventListener("click",(()=>{const e=t.filter((e=>e.id===u));l.getSource("markers").getClusterExpansionZoom(u,((t,i)=>{t||l.easeTo({center:e[0].geometry.coordinates,zoom:i+1})}))}))}a.includes(u)||a.push(u)}if(!m){if(!g){const t=document.createElement("div");t.className="marker",t.dataset.id=y,new e.Marker(t).setDraggable(!1).setLngLat(d).addTo(l),p===r&&t.classList.add("active"),t.addEventListener("click",(()=>{c(p);const e=document.getElementById("map").getBoundingClientRect().top+window.scrollY+-140;window.scrollTo({top:e,behavior:"smooth"})}))}o.includes(y)||o.push(y)}}Array.from(i).forEach((e=>{o.includes(e?.dataset?.id)||e.remove()})),Array.from(s).forEach((e=>{a.includes(parseInt(e?.dataset?.clusterId))||e.remove()}))})()}));const t=location.hash.slice(location.hash.lastIndexOf("-")+1),s=document.getElementById(t);if(s&&s.closest(".map.carousel")){const e=[...s.parentElement.children].findIndex((({id:e})=>e===t));setTimeout((()=>c(e)),50)}else c(0,!1)}))}))})();